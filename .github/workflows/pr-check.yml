name: PR Orchestrator

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Backend Checks
  lint-backend:
    uses: ./.github/workflows/lint.yml
    with:
      working-directory: ./backend

  test-backend:
    needs: lint-backend
    uses: ./.github/workflows/test.yml
    with:
      working-directory: ./backend

  # Frontend Checks
  lint-frontend:
    uses: ./.github/workflows/lint.yml
    with:
      working-directory: ./frontend

  test-frontend:
    needs: lint-frontend
    uses: ./.github/workflows/test.yml
    with:
      working-directory: ./frontend

  # Security Scan (Trivy on source code/config)
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Trivy vulnerability scanner in repo mode
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          trivy-config: trivy.yaml
          ignore-unfixed: true
          format: 'table'
          severity: 'CRITICAL,HIGH'
        env:
          TRIVY_skip_db_update: true
          TRIVY_offline_scan: false

  # Block Merge if Checks Fail
  check-status:
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend, security-scan]
    if: always()
    steps:
      - name: Check Status
        run: |
          if [[ "${{ needs.test-backend.result }}" != "success" ]]; then exit 1; fi
          if [[ "${{ needs.test-frontend.result }}" != "success" ]]; then exit 1; fi
          if [[ "${{ needs.security-scan.result }}" != "success" ]]; then exit 1; fi
          echo "All checks passed!"
