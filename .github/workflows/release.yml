name: Release Manager

on:
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version Bump Type'
        required: true
        default: 'patch'
        type: choice
        options:
        - major
        - minor
        - patch
        - beta
      channel:
        description: 'Release Channel'
        required: true
        default: 'stable'
        type: choice
        options:
        - stable
        - beta

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.bump.outputs.version }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify Branch
        if: inputs.channel == 'stable' && github.ref != 'refs/heads/main'
        run: |
          echo "Error: Stable releases must be created from main branch."
          exit 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Bump Version
        id: bump
        run: |
          # Use script to bump version
          NEW_VERSION=$(python3 scripts/manage_version.py bump --type ${{ inputs.bump }})
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          
          # Setup Git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Commit Changes
          git add VERSION
          git commit -m "chore(release): bump version to $NEW_VERSION"
          git push

      - name: Create Tag
        run: |
          TAG="v${{ steps.bump.outputs.version }}"
          git tag $TAG
          git push origin $TAG

      - name: Generate Release Notes
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.bump.outputs.version }}
          prerelease: ${{ inputs.channel == 'beta' }}
          generate_release_notes: true

  build-and-push:
    needs: prepare-release
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [backend, frontend]

    steps:
      - uses: actions/checkout@v4
        with:
          ref: v${{ needs.prepare-release.outputs.new_version }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Determine Tags
        id: meta
        run: |
          VERSION=${{ needs.prepare-release.outputs.new_version }}
          IMAGE_NAME=ghcr.io/${{ github.repository }}/${{ matrix.service }}
          
          TAGS="$IMAGE_NAME:$VERSION"
          
          # If stable, add latest
          if [[ "${{ inputs.channel }}" == "stable" ]]; then
            TAGS="$TAGS,$IMAGE_NAME:latest"
          fi
          
          echo "tags=$TAGS" >> $GITHUB_OUTPUT

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  post-release:
    needs: [prepare-release, build-and-push]
    runs-on: ubuntu-latest
    if: inputs.channel == 'stable' # Only bump to dev after stable (or optionally after beta)
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main # Ensure we are on main
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Pull latest
        run: git pull origin main
      
      - name: Bump to Dev
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Bump to next patch-dev
          NEXT_DEV=$(python3 scripts/manage_version.py bump --type dev)
          
          git add VERSION
          git commit -m "chore: bump to next development version $NEXT_DEV"
          git push
