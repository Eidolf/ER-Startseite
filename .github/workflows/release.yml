name: Release

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release Type'
        required: true
        default: 'nightly'
        type: choice
        options:
        - nightly
        - beta
        - stable

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Determine Version
        id: version
        run: |
          if [[ "${{ inputs.release_type }}" == "nightly" ]]; then
            # Nightly: 0.0.0-nightly.YYYYMMDD.SHA
            DATE=$(date +%Y%m%d)
            SHA=$(git rev-parse --short HEAD)
            echo "new_version=0.0.0-nightly.${DATE}.${SHA}" >> $GITHUB_OUTPUT
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            # Beta/Stable: Use manager
            TYPE="patch"
            if [[ "${{ inputs.release_type }}" == "beta" ]]; then TYPE="beta"; fi
            
            NEW_VER=$(python3 scripts/version_manager.py bump --type $TYPE)
            echo "new_version=$NEW_VER" >> $GITHUB_OUTPUT
            
            IS_PRE="false"
            if [[ "${{ inputs.release_type }}" == "beta" ]]; then IS_PRE="true"; fi
            echo "is_prerelease=$IS_PRE" >> $GITHUB_OUTPUT
            
            # Commit File Change
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add VERSION
            git commit -m "chore(release): bump version to $NEW_VER"
            git push
          fi

      - name: Create Tag
        run: |
          TAG="v${{ steps.version.outputs.new_version }}"
          git tag $TAG
          git push origin $TAG

      - name: Generate Release Notes
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.new_version }}
          prerelease: ${{ steps.version.outputs.is_prerelease }}
          generate_release_notes: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and Push Docker
        run: |
          VERSION=${{ steps.version.outputs.new_version }}
          REPO=ghcr.io/${{ github.repository }}
          
          for SERVICE in backend frontend; do
            TAGS="$REPO/$SERVICE:$VERSION"
            if [[ "${{ inputs.release_type }}" == "stable" ]]; then
              TAGS="$TAGS,$REPO/$SERVICE:latest"
            fi
            
            echo "Building $SERVICE with tags: $TAGS"
            docker buildx build \
              --push \
              --tag $TAGS \
              --cache-from type=gha \
              --cache-to type=gha,mode=max \
              ./$SERVICE
          done

      - name: Bump Dev Version (Post-Release)
        if: inputs.release_type != 'nightly'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull origin main
          
          NEXT_DEV=$(python3 scripts/version_manager.py bump --type dev)
          git add VERSION
          git commit -m "chore: bump to dev version $NEXT_DEV"
          git push
